version: 2

models:
  - name: stg_amazon_purchases
    description: |
      Staged Amazon order records: type-cast, trimmed, deduplicated on 
      (survey_response_id, order_date, state, unit_price, quantity, product_code),
      and filtered to valid dates, prices, quantities, and non-null state.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - survey_responseid
            - order_date
            - state
            - unit_price
            - quantity
            - product_code

    columns:
      - name: survey_responseid
        description: User ID linking each order to the survey
        tests: [not_null]

      - name: order_date
        description: Date the order was placed
        tests: [not_null]

      - name: state
        description: Two-letter US state code for shipping address
        
      - name: unit_price
        description: Purchase price per unit (USD)
        tests:
          - dbt_utils.expression_is_true:
              expression: "> 0"

      - name: quantity
        description: Number of units purchased
        tests:
          - dbt_utils.expression_is_true:
              expression: "> 0"

      - name: product_code
        description: ASIN or ISBN code of the product

      - name: title
        description: Product title (NULL if missing)
        
      - name: category
        description: Upper-cased product category (NULL if missing)
    
      - name: order_year
        description: Extracted year of the order date

      - name: order_month
        description: Extracted month of the order date

      - name: order_quarter
        description: Extracted quarter of the order date

      - name: order_dow
        description: Day-of-week (3-letter) of the order date

        
  - name: stg_survey
    description: |
      Staged survey responses:
      - Hispanic flag cast to boolean 
      - Trim and normalize text fields  
      - Filter out any rows missing survey_responseid
    tests:
      - unique:
          column_name: survey_responseid

    columns:
      - name: survey_responseid
        description: Unique respondent ID (links purchases)
        tests: [not_null]

      - name: age_group
        description: Age bucket from survey, e.g. "25 - 34 years"

      - name: is_hispanic
        description: Boolean flag for Hispanic ethnicity
  

      - name: race
        description: Respondent’s race category (uppercased)

      - name: education
        description: Highest education level (uppercased)

      - name: income_bracket
        description: Household income bracket as text

      - name: gender
        description: Raw gender entry trimmed and uppercased

      - name: sexual_orientation
        description: Self-reported sexual orientation (uppercased)

      - name: state
        description: State of residence (2-letter code)

      - name: accounts_shared_cat
        description: “How many share account” bucket, e.g. “1 (just me!)”

      - name: household_size_cat
        description: Household size bucket, e.g. “4+”

      - name: purchase_frequency
        description: Amazon purchase frequency bucket

      - name: substance_use_cigarettes
        description: Cigarette use frequency/text

      - name: substance_use_marijuana
        description: Marijuana use frequency/text

      - name: substance_use_alcohol
        description: Alcohol use frequency/text

      - name: personal_diabetes
        description: Diabetes medication usage text

      - name: personal_wheelchair
        description: Wheelchair usage text

      - name: life_changes
        description: Reported life events (nullable)

      - name: sell_your_data
        description: Agreement to sell own data (text)

      - name: sell_consumer_data
        description: Agreement to sell consumer data (text)

      - name: small_biz_use
        description: Likelihood to use data for small business (text)

      - name: census_use
        description: Likelihood to use data for Census research (text)

      - name: research_society
        description: Likelihood to use data for academic/society research (text)
 

  - name: stg_state_demographics
    description: |
      Staged ACS 5-year state demographics (2018–2023) with:
      • state_name  
      • median_household_income  
      • total_population  
      • state_fips_code (ANSI/FIPS)  
      • survey_year

    tests:
      # one row per (survey_year, state_fips_code)
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - survey_year
            - state_fips

    columns:
      - name: survey_year
        tests: [not_null]

      - name: state_name
        tests: [not_null]

      - name: median_household_income
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: total_population
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "> 0"
      - name: state_fips
        description: Two‐character FIPS code, preserving leading zeros (e.g. "01")
        tests:
          - not_null
          - accepted_values:
              values:
                - '01'
                - '02'
                - '04'
                - '05'
                - '06'
                - '08'
                - '09'
                - '10'
                - '11'
                - '12'
                - '13'
                - '15'
                - '16'
                - '17'
                - '18'
                - '19'
                - '20'
                - '21'
                - '22'
                - '23'
                - '24'
                - '25'
                - '26'
                - '27'
                - '28'
                - '29'
                - '30'
                - '31'
                - '32'
                - '33'
                - '34'
                - '35'
                - '36'
                - '37'
                - '38'
                - '39'
                - '40'
                - '41'
                - '42'
                - '44'
                - '45'
                - '46'
                - '47'
                - '48'
                - '49'
                - '50'
                - '51'
                - '53'
                - '54'
                - '55'
                - '56'
                - '72'
  
  
  - name: stg_state_codes
    description: |
      Staged state codes mapping postal_code ↔ state_name ↔ state_fips.
    tests:
      - unique:
          column_name: postal_code
      - not_null:
          column_name: postal_code
      - not_null:
          column_name: state_fips

    columns:
      - name: postal_code
        description: USPS two-letter code (e.g. “CA”)
      - name: state_name
        description: Full state name (e.g. “California”)
      - name: state_fips
        description: Two-character FIPS code with leading zeros (e.g. “06”)