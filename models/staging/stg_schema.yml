version: 2

models:
  - name: stg_amazon_purchases
    description: |
      Staged Amazon order records: type-cast, trimmed, deduplicated on 
      (survey_response_id, order_date, state, unit_price, quantity, product_code),
      and filtered to valid dates, prices, quantities, and non-null state.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - survey_responseid
            - order_date
            - state
            - unit_price
            - quantity
            - product_code

    columns:
      - name: survey_responseid
        description: User ID linking each order to the survey
        tests: [not_null]

      - name: order_date
        description: Date the order was placed
        tests: [not_null]

      - name: state
        description: Two-letter US state code for shipping address
        
      - name: unit_price
        description: Purchase price per unit (USD)
        tests:
          - dbt_utils.expression_is_true:
              expression: "> 0"

      - name: quantity
        description: Number of units purchased
        tests:
          - dbt_utils.expression_is_true:
              expression: "> 0"

      - name: product_code
        description: ASIN or ISBN code of the product

      - name: title
        description: Product title (NULL if missing)
        
      - name: category
        description: Upper-cased product category (NULL if missing)
    
      - name: order_year
        description: Extracted year of the order date

      - name: order_month
        description: Extracted month of the order date

      - name: order_quarter
        description: Extracted quarter of the order date

      - name: order_dow
        description: Day-of-week (3-letter) of the order date

        
  - name: stg_survey
    description: |
      Staged survey responses:
      - Hispanic flag cast to boolean 
      - Trim and normalize text fields  
      - Filter out any rows missing survey_responseid
    tests:
      - unique:
          column_name: survey_responseid

    columns:
      - name: survey_responseid
        description: Unique respondent ID (links purchases)
        tests: [not_null]

      - name: age_group
        description: Age bucket from survey, e.g. "25 - 34 years"

      - name: is_hispanic
        description: Boolean flag for Hispanic ethnicity
        tests:
          - not_null

      - name: race
        description: Respondent’s race category (uppercased)

      - name: education
        description: Highest education level (uppercased)

      - name: income_bracket
        description: Household income bracket as text

      - name: gender
        description: Raw gender entry trimmed and uppercased

      - name: sexual_orientation
        description: Self-reported sexual orientation (uppercased)

      - name: state
        description: State of residence (2-letter code)

      - name: accounts_shared_cat
        description: “How many share account” bucket, e.g. “1 (just me!)”

      - name: household_size_cat
        description: Household size bucket, e.g. “4+”

      - name: purchase_frequency
        description: Amazon purchase frequency bucket

      - name: substance_use_cigarettes
        description: Cigarette use frequency/text

      - name: substance_use_marijuana
        description: Marijuana use frequency/text

      - name: substance_use_alcohol
        description: Alcohol use frequency/text

      - name: personal_diabetes
        description: Diabetes medication usage text

      - name: personal_wheelchair
        description: Wheelchair usage text

      - name: life_changes
        description: Reported life events (nullable)

      - name: sell_your_data
        description: Agreement to sell own data (text)

      - name: sell_consumer_data
        description: Agreement to sell consumer data (text)

      - name: small_biz_use
        description: Likelihood to use data for small business (text)

      - name: census_use
        description: Likelihood to use data for Census research (text)

      - name: research_society
        description: Likelihood to use data for academic/society research (text)